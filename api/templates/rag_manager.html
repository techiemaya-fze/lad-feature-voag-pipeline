<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Base Manager - TechieMaya</title>
    <style>
        :root {
            --primary-color: #1a2a4a;
            --primary-hover: #243756;
            --accent-color: #3b82f6;
            --bg-color: #f3f4f6;
            --sidebar-width: 280px;
            --header-height: 64px;
            --border-color: #e5e7eb;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --success-color: #22c55e;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        .sidebar-header {
            height: var(--header-height);
            padding: 0 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            gap: 12px;
        }

        .brand-logo {
            height: 32px;
            width: auto;
        }

        .brand-text {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary-color);
        }

        .sidebar-search {
            padding: 16px;
        }

        .sidebar-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: #f9fafb;
            font-size: 0.9rem;
        }

        .nav-section-title {
            padding: 8px 20px;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            font-weight: 600;
            letter-spacing: 0.05em;
            margin-top: 8px;
        }

        .nav-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .nav-item {
            padding: 10px 12px;
            margin-bottom: 2px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: #f3f4f6;
        }

        .nav-item.active {
            background: #eff6ff;
            color: var(--primary-color);
            font-weight: 500;
        }

        .nav-item-icon {
            color: var(--text-secondary);
            width: 18px;
            height: 18px;
        }

        .nav-item.active .nav-item-icon {
            color: var(--primary-color);
        }

        .kb-icon {
            color: #f59e0b;
            /* Folder color */
        }

        .nav-item-actions {
            margin-left: auto;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .nav-item:hover .nav-item-actions {
            opacity: 1;
        }

        .action-btn-sm {
            padding: 4px;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .action-btn-sm:hover {
            background: #e5e7eb;
            color: var(--text-primary);
        }

        .create-kb-btn {
            margin: 16px;
            padding: 10px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .create-kb-btn:hover {
            background: var(--primary-hover);
        }

        .user-panel {
            padding: 16px;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* --- Main Content --- */
        .main-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Top Bar */
        .top-bar {
            height: var(--header-height);
            background: white;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .breadcrumb span.active {
            color: var(--text-primary);
            font-weight: 500;
        }

        .search-bar {
            position: relative;
            width: 400px;
        }

        .search-bar input {
            width: 100%;
            padding: 8px 16px 8px 36px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background: #f9fafb;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            width: 16px;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        /* KB Header */
        .kb-view-header {
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .kb-title-block {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .kb-icon-lg {
            width: 48px;
            height: 48px;
            color: #f59e0b;
        }

        .kb-name {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .kb-meta {
            color: var(--text-secondary);
            font-size: 0.9rem;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-success {
            background: #dcfce7;
            color: #166534;
        }

        .badge-gray {
            background: #e5e7eb;
            color: #374151;
        }

        .kb-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: white;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            border-color: transparent;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-danger {
            color: var(--danger-color);
            border-color: #fecaca;
            background: #fef2f2;
        }

        .btn-danger:hover {
            background: #fee2e2;
        }

        /* File Explorer */
        .file-toolbar {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px 8px 0 0;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-list {
            background: white;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 8px 8px;
            min-height: 400px;
        }

        .file-table {
            width: 100%;
            border-collapse: collapse;
        }

        .file-table th {
            text-align: left;
            padding: 12px 16px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--border-color);
            background: #f9fafb;
        }

        .file-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
        }

        .file-table tr:hover {
            background: #f9fafb;
        }

        .file-name-cell {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .file-icon {
            width: 24px;
            height: 24px;
            color: var(--text-secondary);
        }

        .file-action-btn {
            opacity: 0;
            padding: 6px;
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-table tr:hover .file-action-btn {
            opacity: 1;
        }

        .file-action-btn:hover {
            background: #fee2e2;
            color: var(--danger-color);
        }

        /* Upload Area */
        .upload-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border: 4px dashed var(--primary-color);
            margin: 12px;
            border-radius: 12px;
        }

        .upload-overlay.active {
            display: flex;
        }

        /* Login Screen */
        .login-wrapper {
            position: fixed;
            inset: 0;
            background: #f5f7fa;
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            width: 400px;
            text-align: center;
        }

        .login-logo {
            height: 48px;
            margin-bottom: 24px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: 2px solid var(--primary-color);
            border-color: transparent;
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-muted {
            color: var(--text-secondary);
        }

        /* View Toggles */
        .view-toggle {
            display: flex;
            background: #f3f4f6;
            padding: 2px;
            border-radius: 6px;
            gap: 2px;
        }

        .view-toggle-btn {
            padding: 6px;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .view-toggle-btn.active {
            background: white;
            color: var(--primary-color);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        /* File Grid View */
        .file-grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
            padding: 4px;
        }

        .file-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: all 0.2s;
            position: relative;
        }

        .file-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .file-card-icon {
            width: 40px;
            height: 40px;
            color: var(--text-secondary);
            background: #f9fafb;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-card-name {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .file-card-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-card-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .file-card:hover .file-card-actions {
            opacity: 1;
        }

        /* Chat Widget */
        .chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            /* User requested right side */
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            transform: translateY(0);
            opacity: 1;
        }

        .chat-widget.hidden {
            transform: translateY(20px);
            opacity: 0;
            pointer-events: none;
            display: flex !important;
            /* Override .hidden display:none for transition */
            visibility: hidden;
        }

        .chat-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9fafb;
            border-radius: 12px 12px 0 0;
        }

        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #ffffff;
        }

        .chat-message {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .chat-message.user {
            align-self: flex-end;
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .chat-message.bot {
            align-self: flex-start;
            background: #f3f4f6;
            color: var(--text-primary);
            border-bottom-left-radius: 2px;
        }

        .chat-input-area {
            padding: 12px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 16px;
            outline: none;
            font-size: 0.9rem;
        }

        .chat-input:focus {
            border-color: var(--primary-color);
        }
    </style>
</head>

<body>

    <!-- Login Screen -->
    <div id="login-screen" class="login-wrapper">
        <div class="login-card">
            <img src="/auth/microsoft/logo" alt="Logo" class="login-logo">
            <h2 style="margin-bottom: 8px; color: var(--primary-color)">RAG Manager Login</h2>
            <p class="text-muted" style="margin-bottom: 24px">Enter your API credentials to continue</p>

            <div id="login-error" style="color:red; margin-bottom:16px; display:none; font-size: 0.9rem;"></div>

            <form id="login-form">
                <input type="text" id="frontend-id" class="form-input" placeholder="Frontend ID" required>
                <input type="password" id="api-key" class="form-input" placeholder="API Key" required>
                <div style="text-align: left; margin-bottom: 24px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="remember-me"> <span class="text-sm">Remember me</span>
                    </label>
                </div>
                <button type="submit" class="btn btn-primary"
                    style="width: 100%; justify-content: center; padding: 12px;">Sign In</button>
            </form>
        </div>
    </div>

    <!-- App UI -->
    <div id="app-ui" class="hidden" style="display: flex; width: 100%; height: 100%;">

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="/auth/microsoft/logo" alt="Logo" class="brand-logo">
                <span class="brand-text">TechieMaya</span>
            </div>

            <button class="create-kb-btn" onclick="showCreateModal()">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                New Knowledge Base
            </button>

            <div class="nav-section-title">Knowledge Bases</div>
            <div class="nav-list" id="kb-list">
                <!-- KB Items injected here -->
            </div>

            <div class="user-panel">
                <div class="user-avatar" id="user-initial">U</div>
                <div style="flex: 1; overflow: hidden;">
                    <div style="font-weight: 500; font-size: 0.9rem;" id="user-display-id">User</div>
                    <div class="text-sm text-muted">Admin</div>
                </div>
                <svg onclick="logout()" style="cursor: pointer; color: var(--text-secondary);" width="20" height="20"
                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-col">
            <!-- Upload Overlay -->
            <div id="upload-overlay" class="upload-overlay">
                <svg width="64" height="64" color="#1a2a4a" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <h2 style="margin-top: 20px; color: var(--primary-color)">Drop files to upload</h2>
                <p class="text-muted">Files will be added to the current knowledge base</p>
            </div>

            <div class="top-bar">
                <div class="breadcrumb" id="breadcrumb">
                    <span>Knowledge Bases</span>
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                    <span class="active" id="current-kb-name">-</span>
                </div>
                <div class="search-bar">
                    <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input type="text" placeholder="Search documents..." id="doc-search">
                </div>
            </div>

            <div class="content-area" id="content-area">

                <!-- Home View (Folders Grid) -->
                <div id="home-view">
                    <div class="kb-view-header">
                        <div class="kb-title-block">
                            <h2 style="color: var(--text-primary);">Knowledge Bases</h2>
                        </div>
                        <button class="btn btn-primary" onclick="showCreateModal()">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4" />
                            </svg>
                            New Knowledge Base
                        </button>
                    </div>

                    <div id="kb-grid-loading" class="hidden"
                        style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div class="spinner"
                            style="margin: 0 auto 12px; border-color: #e5e7eb; border-top-color: var(--primary-color);">
                        </div>
                        Loading knowledge bases...
                    </div>

                    <div id="kb-grid"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
                        <!-- KB Folders injected here -->
                    </div>
                </div>

                <!-- KB View (File Explorer) -->
                <div id="kb-view" class="hidden" style="max-width: 1200px; margin: 0 auto; padding: 20px;">

                    <!-- Header Actions Row -->
                    <div
                        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px;">

                        <!-- Left: Back + KB Info -->
                        <div style="display: flex; gap: 16px; align-items: center;">
                            <button class="btn"
                                style="border:none; padding:8px; border-radius: 50%; background: #f3f4f6;"
                                onclick="showHome()" title="Back to KBs">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                                </svg>
                            </button>

                            <div style="display: flex; gap: 16px; align-items: center;">
                                <div style="background: #fef3c7; padding: 12px; border-radius: 12px;">
                                    <svg class="kb-icon-lg" style="width: 32px; height: 32px; color: #d97706;"
                                        fill="currentColor" viewBox="0 0 20 20">
                                        <path
                                            d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" />
                                    </svg>
                                </div>
                                <div>
                                    <h2 class="kb-name" id="view-kb-name" style="margin: 0; font-size: 1.5rem;">Product
                                        Manuals</h2>
                                    <div class="kb-meta"
                                        style="margin-top: 4px; display: flex; gap: 8px; align-items: center;">
                                        <span id="view-kb-stats">0 docs</span>
                                        <span id="view-kb-default" class="badge badge-success hidden">Default</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Actions + View Toggle -->
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <div class="view-toggle">
                                <button class="view-toggle-btn active" id="btn-view-list" onclick="setFileView('list')"
                                    title="List View">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 6h16M4 12h16M4 18h16" />
                                    </svg>
                                </button>
                                <button class="view-toggle-btn" id="btn-view-grid" onclick="setFileView('grid')"
                                    title="Grid View">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H16a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H16a2 2 0 01-2-2v-2z" />
                                    </svg>
                                </button>
                                <button class="view-toggle-btn" id="btn-chat-toggle" onclick="toggleChat()"
                                    title="Chat with KB" style="color: var(--primary-color);">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                                    </svg>
                                </button>
                                <button class="view-toggle-btn" id="btn-settings" onclick="showKbSettings()"
                                    title="KB Settings">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </button>
                            </div>

                            <div style="height: 24px; width: 1px; background: var(--border-color); margin: 0 4px;">
                            </div>

                            <button class="btn btn-primary" onclick="triggerUpload()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                </svg>
                                Upload Files
                            </button>
                            <input type="file" id="file-input" multiple hidden>

                            <button class="btn btn-danger" onclick="confirmDeleteStore()" title="Delete Knowledge Base">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- File Explorer Content -->
                    <div
                        style="background: white; border: 1px solid var(--border-color); border-radius: 8px; min-height: 400px; position: relative;">

                        <!-- List View -->
                        <div id="file-view-list">
                            <table class="file-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50%">Name</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th style="width: 100px; text-align: right;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="file-list-body">
                                    <!-- Files injected here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Grid View -->
                        <div id="file-view-grid" class="hidden">
                            <div id="file-grid-container" class="file-grid-container">
                                <!-- Cards injected here -->
                            </div>
                        </div>

                        <!-- Loading State -->
                        <div id="file-loading" class="hidden"
                            style="position: absolute; inset: 0; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; z-index: 10;">
                            <div style="text-align: center; color: var(--text-secondary);">
                                <div class="spinner"
                                    style="margin: 0 auto 12px; width: 32px; height: 32px; border: 3px solid #e5e7eb; border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite;">
                                </div>
                                Loading documents...
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div id="file-empty" class="hidden" style="padding: 80px; text-align: center;">
                            <div
                                style="width: 64px; height: 64px; background: #f3f4f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; color: var(--text-secondary);">
                                <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                            </div>
                            <h3 style="color: var(--text-primary); margin-bottom: 8px;">No files yet</h3>
                            <p class="text-muted" style="margin-bottom: 24px;">Upload documents to get started with this
                                knowledge base.</p>
                            <button class="btn btn-primary" onclick="triggerUpload()">Upload Files</button>
                        </div>
                    </div>
                </div>

                <!-- Upload Progress Footer -->
                <div id="upload-progress-bar" class="hidden"
                    style="background: white; border-top: 1px solid var(--border-color); padding: 12px 24px; display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="spinner"
                            style="width: 20px; height: 20px; border: 2px solid #e5e7eb; border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite;">
                        </div>
                        <span id="upload-status-text">Uploading 3 files...</span>
                    </div>
                    <div style="width: 200px; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                        <div id="upload-fill"
                            style="width: 0%; background: var(--success-color); height: 100%; transition: width 0.3s;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="modal-overlay" class="hidden"
            style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 300; display: flex; align-items: center; justify-content: center;">
            <div class="login-card" style="width: 450px; text-align: left; padding: 24px;">
                <h3 id="modal-title" style="margin-bottom: 20px; color: var(--primary-color);">Create Knowledge Base
                </h3>
                <div id="modal-content">
                    <!-- Dynamic Content -->
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
                    <button class="btn" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" id="modal-confirm">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Chat Widget -->
        <div id="chat-widget" class="chat-widget hidden">
            <div class="chat-header">
                <div style="font-weight: 600; font-size: 1rem; color: var(--text-primary);">Chat with KB</div>
                <button onclick="toggleChat()"
                    style="background:none; border:none; cursor:pointer; color: var(--text-secondary);">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="chat-messages" id="chat-messages">
                <div class="chat-message bot">Hello! Ask me anything about your documents.</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" class="chat-input" placeholder="Type a message..."
                    onkeypress="handleChatKey(event)">
                <button class="btn btn-primary" style="padding: 8px 12px; border-radius: 50%;"
                    onclick="sendChatMessage()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        style="transform: rotate(45deg); margin-left: -2px; margin-top: 2px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>
        </div>


        <!-- Polished Settings Modal -->
        <div id="settings-modal" class="hidden"
            style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1100; display: flex; align-items: start; justify-content: center; padding-top: 80px;">
            <div class="settings-card"
                style="background: white; border-radius: 16px; width: 600px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); display: flex; flex-direction: column;">

                <div style="padding: 24px 24px 0; display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: var(--text-primary);">KB
                            Settings</h3>
                        <p class="text-muted" style="margin: 4px 0 0; font-size: 0.875rem;">Configure your knowledge
                            base properties</p>
                    </div>
                    <button onclick="closeSettingsModal()"
                        style="background: #f3f4f6; padding: 6px; border-radius: 8px; border: none; cursor: pointer; color: var(--text-secondary);">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div style="padding: 24px; flex: 1; overflow-y: auto;">
                    <div id="settings-linked-badge" class="hidden"
                        style="background: #ecfdf5; border: 1px solid #a7f3d0; color: #047857; padding: 12px; border-radius: 10px; margin-bottom: 24px; display: flex; align-items: start; gap: 12px;">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            style="margin-top: 2px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>
                            <div style="font-weight: 600;">Linked to Database</div>
                            <div style="font-size: 0.8rem; opacity: 0.9;">Synced with tenant ID.</div>
                        </div>
                        <div id="settings-info" style="margin-left: auto; display: flex; gap: 8px; font-size: 0.75rem;">
                            <span style="background: rgba(255,255,255,0.5); padding: 2px 6px; border-radius: 4px;">ID:
                                <span id="settings-db-id">-</span></span>
                            <span style="background: rgba(255,255,255,0.5); padding: 2px 6px; border-radius: 4px;">
                                <span id="settings-created-at">-</span></span>
                            <span style="background: rgba(255,255,255,0.5); padding: 2px 6px; border-radius: 4px;">Docs:
                                <span id="settings-doc-count">0</span></span>
                        </div>
                    </div>

                    <div id="settings-unlinked-badge" class="hidden"
                        style="background: #fffbeb; border: 1px solid #fcd34d; color: #b45309; padding: 12px; border-radius: 10px; margin-bottom: 24px; display: flex; align-items: start; gap: 12px;">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            style="margin-top: 2px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <div>
                            <div style="font-weight: 600;">Not Linked</div>
                            <div style="font-size: 0.8rem; opacity: 0.9;">Link this KB to a tenant to enable management.
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; gap: 20px;">
                        <div>
                            <label
                                style="font-size: 0.875rem; font-weight: 500; margin-bottom: 6px; display: block; color: var(--text-secondary);">Display
                                Name</label>
                            <input type="text" id="settings-display-name" class="form-input"
                                placeholder="e.g., Global Sales Manual">
                        </div>

                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 16px;">
                            <div>
                                <label
                                    style="font-size: 0.875rem; font-weight: 500; margin-bottom: 6px; display: block; color: var(--text-secondary);">Tenant
                                    ID <span style="color: var(--danger-color);">*</span></label>
                                <input type="text" id="settings-tenant-id" class="form-input" placeholder="Tenant UUID"
                                    style="font-family: monospace;">
                            </div>
                            <div>
                                <label
                                    style="font-size: 0.875rem; font-weight: 500; margin-bottom: 6px; display: block; color: var(--text-secondary);">Priority</label>
                                <input type="number" id="settings-priority" class="form-input" min="0" max="100">
                            </div>
                        </div>

                        <div>
                            <label
                                style="font-size: 0.875rem; font-weight: 500; margin-bottom: 6px; display: block; color: var(--text-secondary);">Description</label>
                            <textarea id="settings-description" class="form-input" rows="3"
                                placeholder="What's in this KB?"></textarea>
                        </div>

                        <div>
                            <label
                                style="font-size: 0.875rem; font-weight: 500; margin-bottom: 6px; display: block; color: var(--text-secondary);">Gemini
                                Store ID</label>
                            <input type="text" id="settings-gemini-name" class="form-input" readonly
                                style="background: #f9fafb; color: var(--text-secondary); font-size: 0.85rem; font-family: monospace; border-color: transparent;">
                        </div>

                        <div
                            style="display: flex; gap: 24px; padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid var(--border-color);">
                            <label style="display: flex; gap: 8px; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="settings-is-default"
                                    style="width: 16px; height: 16px; accent-color: var(--primary-color);">
                                <span style="font-size: 0.875rem; font-weight: 500;">Default Store</span>
                            </label>
                            <label style="display: flex; gap: 8px; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="settings-is-active" checked
                                    style="width: 16px; height: 16px; accent-color: var(--primary-color);">
                                <span style="font-size: 0.875rem; font-weight: 500;">Active</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div
                    style="padding: 24px; border-top: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; background: #fafafa; border-radius: 0 0 16px 16px;">
                    <button id="settings-unlink-btn" class="hidden" onclick="unlinkKb()"
                        style="color: var(--danger-color); background: none; border: none; font-size: 0.875rem; cursor: pointer; text-decoration: underline;">
                        Unlink from Database
                    </button>
                    <div style="display: flex; gap: 12px; margin-left: auto;">
                        <button class="btn"
                            style="background: white; border: 1px solid var(--border-color); color: var(--text-primary);"
                            onclick="closeSettingsModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveKbSettings()">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // --- Logic ---
            let auth = { frontendId: '', apiKey: '' };
            let stores = [];
            let currentStoreId = null;

            // API Helpers
            async function apiCall(endpoint, method = 'GET', body = null, isFormData = false) {
                const headers = { 'X-Frontend-ID': auth.frontendId, 'X-API-Key': auth.apiKey };
                if (!isFormData) headers['Content-Type'] = 'application/json';

                const options = { method, headers };
                if (body) options.body = isFormData ? body : JSON.stringify(body);

                const res = await fetch(`/knowledge-base${endpoint}`, options);
                if (!res.ok) throw new Error((await res.json()).detail || 'Request failed');
                return res.json();
            }

            // Auth
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const fid = document.getElementById('frontend-id').value;
                const key = document.getElementById('api-key').value;

                try {
                    // Validate credentials via a cheap call
                    const headers = { 'X-Frontend-ID': fid, 'X-API-Key': key };
                    const res = await fetch('/knowledge-base/gemini-stores', { headers }); // Use endpoint that needs auth

                    if (res.ok || res.status === 404 || res.status === 200) {
                        auth = { frontendId: fid, apiKey: key };
                        if (document.getElementById('remember-me').checked) {
                            localStorage.setItem('rag_auth', JSON.stringify(auth));
                        } else {
                            sessionStorage.setItem('rag_auth', JSON.stringify(auth));
                        }
                        initApp();
                    } else {
                        throw new Error('Invalid credentials');
                    }
                } catch (err) {
                    document.getElementById('login-error').textContent = 'Invalid ID or API Key';
                    document.getElementById('login-error').style.display = 'block';
                }
            });

            function logout() {
                localStorage.removeItem('rag_auth');
                sessionStorage.removeItem('rag_auth');
                location.reload();
            }

            async function initApp() {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-ui').classList.remove('hidden');
                document.getElementById('user-display-id').textContent = auth.frontendId;
                document.getElementById('user-initial').textContent = auth.frontendId.charAt(0).toUpperCase();

                await loadStores();
            }

            // Stores - load from Gemini API (source of truth)
            async function loadStores() {
                document.getElementById('kb-grid-loading').classList.remove('hidden');
                try {
                    const data = await apiCall('/gemini-stores');
                    // Map Gemini store format to UI format (includes DB metadata)
                    const storesList = data.stores || [];
                    stores = storesList.map(s => ({
                        id: s.name.replace('fileSearchStores/', ''),  // Use short name as ID
                        gemini_store_name: s.name,
                        display_name: s.display_name,
                        document_count: s.active_documents || 0,
                        size_bytes: s.size_bytes,
                        size_mb: s.size_mb,
                        // DB metadata from merged response
                        db_id: s.db_id,
                        tenant_id: s.tenant_id,
                        is_default: s.is_default || false,
                        is_linked: s.is_linked || false,
                        priority: s.priority || 0
                    }));
                    renderSidebar();
                    renderHomeGrid();
                } catch (e) {
                    console.error(e);
                    document.getElementById('kb-grid').innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: red;">Failed to load knowledge bases</div>';
                } finally {
                    document.getElementById('kb-grid-loading').classList.add('hidden');
                }
            }

            function renderSidebar() {
                const list = document.getElementById('kb-list');
                list.innerHTML = stores.map(store => `
                        <div class="nav-item ${store.id === currentStoreId ? 'active' : ''}" onclick="selectStore('${store.id}')">
                            <svg class="kb-icon nav-item-icon" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/></svg>
                            <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1;">${store.display_name}</div>
                            ${store.is_default ? '<span style="font-size:10px; padding:2px 4px; background:#dcfce7; color:#166534; border-radius:4px;">DEF</span>' : ''}
                        </div>
                    `).join('');
            }

            function renderHomeGrid() {
                const grid = document.getElementById('kb-grid');
                if (stores.length === 0) {
                    grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--text-secondary); margin-top: 40px;">No knowledge bases found. Create one to get started.</div>';
                    return;
                }

                grid.innerHTML = stores.map(store => `
                        <div onclick="selectStore('${store.id}')" style="background: white; border: 1px solid ${store.is_linked ? 'var(--border-color)' : '#fbbf24'}; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; text-align: center; min-height: 160px; justify-content: center; position: relative;">
                            ${!store.is_linked ? '<div style="position: absolute; top: 8px; right: 8px;"><span style="font-size:10px; padding:2px 6px; background:#fef3c7; color:#92400e; border-radius:4px;">Unlinked</span></div>' : ''}
                            <div style="position: relative;">
                                 <svg style="width: 64px; height: 64px; color: ${store.is_linked ? '#f59e0b' : '#9ca3af'}; margin-bottom: 12px;" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/></svg>
                                 ${store.is_default ? '<span style="position: absolute; bottom: 10px; right: -5px; background: #22c55e; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; border: 2px solid white;">DEF</span>' : ''}
                            </div>
                            <div style="font-weight: 600; font-size: 1rem; color: var(--text-primary); margin-bottom: 4px;">${store.display_name}</div>
                            <div class="text-sm text-muted">${store.document_count || 0} items</div>
                            ${store.tenant_id ? '<div style="font-size:10px; color:#6b7280; margin-top:4px;">Tenant: ' + store.tenant_id.substring(0, 8) + '...</div>' : ''}
                        </div>
                    `).join('');

                document.querySelectorAll('#kb-grid > div').forEach(card => {
                    card.onmouseenter = () => card.style.boxShadow = '0 10px 15px -3px rgba(0, 0, 0, 0.1)';
                    card.onmouseleave = () => card.style.boxShadow = 'none';
                });
            }

            function showHome() {
                currentStoreId = null;
                renderSidebar();

                document.getElementById('home-view').classList.remove('hidden');
                document.getElementById('kb-view').classList.add('hidden');
                document.getElementById('current-kb-name').textContent = '-';

                loadStores();
            }

            async function selectStore(id) {
                currentStoreId = id;
                renderSidebar();

                const store = stores.find(s => s.id === id);

                document.getElementById('home-view').classList.add('hidden');
                document.getElementById('kb-view').classList.remove('hidden');

                document.getElementById('current-kb-name').textContent = store.display_name;
                document.getElementById('view-kb-name').textContent = store.display_name;
                document.getElementById('view-kb-default').classList.toggle('hidden', !store.is_default);
                document.getElementById('view-kb-stats').textContent = `${store.document_count || 0} documents`;

                await loadDocuments(id);
            }

            let currentFileView = 'list';

            function setFileView(view) {
                currentFileView = view;

                // Update buttons
                document.getElementById('btn-view-list').classList.toggle('active', view === 'list');
                document.getElementById('btn-view-grid').classList.toggle('active', view === 'grid');

                // Toggle containers
                document.getElementById('file-view-list').classList.toggle('hidden', view !== 'list');
                document.getElementById('file-view-grid').classList.toggle('hidden', view !== 'grid');
            }

            async function loadDocuments(storeId) {
                const tbody = document.getElementById('file-list-body');
                const gridContainer = document.getElementById('file-grid-container');

                tbody.innerHTML = '';
                gridContainer.innerHTML = '';

                document.getElementById('file-loading').classList.remove('hidden');
                document.getElementById('file-empty').classList.add('hidden');

                // Ensure view state matches current selection
                setFileView(currentFileView);

                try {
                    // Use gemini-stores endpoint (source of truth)
                    const data = await apiCall(`/gemini-stores/${storeId}/documents`);
                    const docs = Array.isArray(data) ? data : (data.documents || []);

                    document.getElementById('file-loading').classList.add('hidden');

                    if (docs.length === 0) {
                        document.getElementById('file-empty').classList.remove('hidden');
                        // Hide both views if empty
                        document.getElementById('file-view-list').classList.add('hidden');
                        document.getElementById('file-view-grid').classList.add('hidden');
                        return;
                    }

                    // Render List View
                    tbody.innerHTML = docs.map(doc => `
                    <tr>
                        <td class="file-name-cell">
                            <svg class="file-icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/></svg>
                            ${doc.display_name || doc.name}
                        </td>
                        <td>${doc.state === 'ACTIVE' ? '<span class="badge badge-success">Active</span>' : '<span class="badge badge-gray">' + doc.state + '</span>'}</td>
                        <td class="text-sm text-muted">${new Date(doc.create_time || Date.now()).toLocaleDateString()}</td>
                        <td style="text-align: right;">
                             <button class="file-action-btn" title="Delete" onclick="deleteDoc('${doc.name}', event)">
                                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                             </button>
                        </td>
                    </tr>
                `).join('');

                    // Render Grid View
                    gridContainer.innerHTML = docs.map(doc => `
                    <div class="file-card">
                        <div style="display:flex; justify-content:space-between; align-items:start;">
                            <div class="file-card-icon">
                                <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/></svg>
                            </div>
                            <button class="btn-icon" style="color:var(--danger-color); padding:4px;" title="Delete" onclick="deleteDoc('${doc.name}', event)">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                        <div class="file-card-name" title="${doc.display_name || doc.name}">${doc.display_name || doc.name}</div>
                        <div class="file-card-meta">
                            <span>${new Date(doc.create_time || Date.now()).toLocaleDateString()}</span>
                            ${doc.state === 'ACTIVE' ? '<span style="color:var(--success-color); font-size: 16px;"></span>' : '<span style="color:gray;"></span>'}
                        </div>
                    </div>
                `).join('');

                } catch (e) {
                    console.error(e);
                    tbody.innerHTML = `<tr><td colspan="4" style="color:red; padding:20px; text-align:center;">Failed to load documents</td></tr>`;
                    document.getElementById('file-loading').classList.add('hidden');
                }
            }

            // --- Actions ---

            // Upload
            function triggerUpload() { document.getElementById('file-input').click(); }

            document.getElementById('file-input').addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                if (!files.length) return;
                uploadFiles(files);
                e.target.value = '';
            });

            // Drag & Drop
            const dropZone = document.getElementById('app-ui');
            const overlay = document.getElementById('upload-overlay');

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (currentStoreId) overlay.classList.add('active');
            });

            dropZone.addEventListener('dragleave', (e) => {
                if (e.relatedTarget === null) overlay.classList.remove('active');
            });

            overlay.addEventListener('dragleave', () => overlay.classList.remove('active'));
            overlay.addEventListener('drop', (e) => {
                e.preventDefault();
                overlay.classList.remove('active');
                if (e.dataTransfer.files.length && currentStoreId) {
                    uploadFiles(Array.from(e.dataTransfer.files));
                }
            });

            async function uploadFiles(files) {
                const progress = document.getElementById('upload-progress-bar');
                const fill = document.getElementById('upload-fill');
                const status = document.getElementById('upload-status-text');

                progress.classList.remove('hidden');
                let completed = 0;

                for (const file of files) {
                    status.textContent = `Uploading ${file.name}...`;
                    try {
                        const fd = new FormData();
                        fd.append('file', file);
                        await apiCall(`/gemini-stores/${currentStoreId}/documents`, 'POST', fd, true);
                        completed++;
                        fill.style.width = `${(completed / files.length) * 100}%`;
                    } catch (e) {
                        console.error('Upload failed', e);
                    }
                }

                status.textContent = 'Upload complete refreshing...';
                setTimeout(() => {
                    progress.classList.add('hidden');
                    fill.style.width = '0%';
                    loadDocuments(currentStoreId);
                    loadStores(); // Refresh stats
                }, 1000);
            }

            // Chat Logic
            function toggleChat() {
                const widget = document.getElementById('chat-widget');
                widget.classList.toggle('hidden');
                if (!widget.classList.contains('hidden')) {
                    document.getElementById('chat-input').focus();
                }
            }

            function handleChatKey(e) {
                if (e.key === 'Enter') sendChatMessage();
            }

            async function sendChatMessage() {
                const input = document.getElementById('chat-input');
                const text = input.value.trim();
                if (!text) return;
                if (!currentStoreId) {
                    alert('Please select a Knowledge Base first');
                    return;
                }

                // Add user message
                const msgContainer = document.getElementById('chat-messages');
                msgContainer.innerHTML += `<div class="chat-message user">${escapeHtml(text)}</div>`;
                input.value = '';
                msgContainer.scrollTop = msgContainer.scrollHeight;

                // Show typing indicator
                msgContainer.innerHTML += `<div class="chat-message bot" id="bot-typing"><span style="animation: pulse 1s infinite;">Thinking...</span></div>`;
                msgContainer.scrollTop = msgContainer.scrollHeight;

                try {
                    // Call the chat endpoint
                    const response = await apiCall(`/gemini-stores/${currentStoreId}/chat`, 'POST', {
                        question: text
                    });

                    // Remove typing indicator
                    const typing = document.getElementById('bot-typing');
                    if (typing) typing.remove();

                    // Display answer
                    let answerHtml = `<div class="chat-message bot">${escapeHtml(response.answer)}`;
                    if (response.sources && response.sources.length > 0) {
                        answerHtml += `<div style="margin-top:8px; font-size:0.75rem; color:var(--text-secondary);">Sources: ${response.sources.join(', ')}</div>`;
                    }
                    answerHtml += `</div>`;
                    msgContainer.innerHTML += answerHtml;
                    msgContainer.scrollTop = msgContainer.scrollHeight;

                } catch (e) {
                    const typing = document.getElementById('bot-typing');
                    if (typing) typing.remove();
                    msgContainer.innerHTML += `<div class="chat-message bot" style="color:var(--danger-color);">Error: ${e.message || 'Failed to get response'}</div>`;
                    msgContainer.scrollTop = msgContainer.scrollHeight;
                }
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // KB Settings Modal
            function showKbSettings() {
                if (!currentStoreId) {
                    alert('Please select a Knowledge Base first');
                    return;
                }

                const store = stores.find(s => s.id === currentStoreId);
                if (!store) return;

                // Populate form fields
                document.getElementById('settings-gemini-name').value = store.gemini_store_name || `fileSearchStores/${currentStoreId}`;
                document.getElementById('settings-display-name').value = store.display_name || '';
                document.getElementById('settings-tenant-id').value = store.tenant_id || '';
                document.getElementById('settings-description').value = store.description || '';
                document.getElementById('settings-priority').value = store.priority || 0;
                document.getElementById('settings-is-default').checked = store.is_default || false;
                document.getElementById('settings-is-active').checked = store.is_active !== false;

                // Show linked/unlinked status
                const isLinked = store.is_linked || store.db_id;
                document.getElementById('settings-linked-badge').classList.toggle('hidden', !isLinked);
                document.getElementById('settings-unlinked-badge').classList.toggle('hidden', isLinked);
                document.getElementById('settings-unlink-btn').classList.toggle('hidden', !isLinked);
                document.getElementById('settings-info').classList.toggle('hidden', !isLinked);

                if (isLinked) {
                    document.getElementById('settings-db-id').textContent = store.db_id || '-';
                    document.getElementById('settings-created-at').textContent = store.created_at ? new Date(store.created_at).toLocaleDateString() : '-';
                    document.getElementById('settings-doc-count').textContent = store.document_count || 0;
                }

                document.getElementById('settings-modal').classList.remove('hidden');
            }

            function closeSettingsModal() {
                document.getElementById('settings-modal').classList.add('hidden');
            }

            async function saveKbSettings() {
                const tenantId = document.getElementById('settings-tenant-id').value.trim();
                if (!tenantId) {
                    alert('Tenant ID is required');
                    return;
                }

                const store = stores.find(s => s.id === currentStoreId);
                const isLinked = store && (store.is_linked || store.db_id);

                const payload = {
                    tenant_id: tenantId,
                    display_name: document.getElementById('settings-display-name').value.trim() || store.display_name,
                    description: document.getElementById('settings-description').value.trim() || null,
                    is_default: document.getElementById('settings-is-default').checked,
                    is_active: document.getElementById('settings-is-active').checked,
                    priority: parseInt(document.getElementById('settings-priority').value) || 0,
                };

                try {
                    if (isLinked) {
                        // Update existing
                        await apiCall(`/gemini-stores/${currentStoreId}/settings`, 'PUT', payload);
                    } else {
                        // Create new link
                        await apiCall(`/gemini-stores/${currentStoreId}/link`, 'POST', payload);
                    }

                    closeSettingsModal();
                    loadStores(); // Refresh data
                    alert('Settings saved successfully!');
                } catch (e) {
                    alert('Save failed: ' + e.message);
                }
            }

            async function unlinkKb() {
                if (!confirm('Are you sure you want to unlink this KB from the database? This will remove the tenant association.')) {
                    return;
                }

                try {
                    await apiCall(`/gemini-stores/${currentStoreId}/unlink`, 'DELETE');
                    closeSettingsModal();
                    loadStores();
                    alert('KB unlinked successfully');
                } catch (e) {
                    alert('Unlink failed: ' + e.message);
                }
            }

            // Modals
            function showCreateModal() {
                document.getElementById('modal-title').textContent = 'Create Knowledge Base';
                document.getElementById('modal-content').innerHTML = `
                <div style="margin-bottom:12px;">
                    <label class="text-sm font-bold">Display Name</label>
                    <input type="text" id="new-store-name" class="form-input" style="margin-top:4px; margin-bottom:8px;">
                </div>
                <label style="display:flex; gap:8px;">
                    <input type="checkbox" id="new-store-default"> <span class="text-sm">Set as default tenant store</span>
                </label>
            `;
                document.getElementById('modal-confirm').onclick = createStore;
                document.getElementById('modal-overlay').classList.remove('hidden');
            }

            async function createStore() {
                const name = document.getElementById('new-store-name').value;
                const isDefault = document.getElementById('new-store-default').checked;
                if (!name) return;

                try {
                    await apiCall('/stores', 'POST', { display_name: name, is_default: isDefault });
                    closeModal();
                    loadStores();
                } catch (e) {
                    alert(e.message);
                }
            }

            function confirmDeleteStore() {
                if (!confirm('Are you sure you want to delete this Knowledge Base? All documents will be lost.')) return;
                apiCall(`/gemini-stores/${currentStoreId}`, 'DELETE').then(() => {
                    showHome();
                });
            }

            async function deleteDoc(docName, e) {
                e.stopPropagation();
                if (!confirm('Delete this file?')) return;

                try {
                    // Encode docName properly for URL
                    await apiCall(`/gemini-stores/${currentStoreId}/documents/${encodeURIComponent(docName)}`, 'DELETE');
                    loadDocuments(currentStoreId);
                    loadStores(); // update stats
                } catch (e) {
                    alert('Delete failed: ' + e.message);
                }
            }

            function closeModal() {
                document.getElementById('modal-overlay').classList.add('hidden');
            }

            // Startup check
            const saved = localStorage.getItem('rag_auth') || sessionStorage.getItem('rag_auth');
            if (saved) {
                auth = JSON.parse(saved);
                initApp();
            }
        </script>

        <style>
            @keyframes spin {
                100% {
                    transform: rotate(360deg);
                }
            }
        </style>
</body>

</html>
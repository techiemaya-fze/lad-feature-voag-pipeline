# =============================================================================
# VONAGE VOICE AGENT - WORKER DOCKERFILE
# =============================================================================
# LiveKit Agent Worker handling voice calls with STT/LLM/TTS pipeline
#
# Build:   docker build -f Dockerfile.worker -t vonage-voice-agent-worker:latest .
# Run:     docker run --network host --env-file .env vonage-voice-agent-worker:latest
#
# IMPORTANT: Use --network host for LiveKit workers in production!
# LiveKit uses WebRTC with dynamic UDP ports (10000-60000) for media.
# Host networking avoids NAT issues and provides lowest latency.
# =============================================================================

# -----------------------------------------------------------------------------
# Stage 1: Base with uv and system dependencies
# -----------------------------------------------------------------------------
FROM python:3.13-slim-bookworm AS base

# Install uv binary from official Astral image (pinned version for reproducibility)
COPY --from=ghcr.io/astral-sh/uv:0.8.22 /uv /uvx /bin/

# Install system dependencies required by LiveKit and audio processing
# - ffmpeg: Audio format conversion and silence trimming
# - libsndfile1: Audio file I/O for speech processing
# - libopus0: Opus codec for WebRTC audio
# - ca-certificates: SSL/TLS for external API calls
RUN apt-get update && apt-get install -y --no-install-recommends \
    ffmpeg \
    libsndfile1 \
    libopus0 \
    ca-certificates \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Environment variables for uv optimization
ENV UV_COMPILE_BYTECODE=1 \
    UV_LINK_MODE=copy \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

# -----------------------------------------------------------------------------
# Stage 2: Dependencies layer (cached unless pyproject.toml/uv.lock change)
# -----------------------------------------------------------------------------
FROM base AS dependencies

# Install dependencies WITHOUT the project itself using bind mounts
# This layer is cached unless pyproject.toml or uv.lock change
RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    uv sync --locked --no-install-project --no-dev

# -----------------------------------------------------------------------------
# Stage 3: Application layer
# -----------------------------------------------------------------------------
FROM dependencies AS application

# Copy the entire project into the image
COPY . /app

# Sync the project (install the project itself, fast since deps are cached)
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --locked --no-dev

# Pre-download Silero VAD and other model files
# This prevents first-run delays and ensures models are baked into the image
RUN uv run -m agent.worker download-files || echo "download-files completed or not available"

# -----------------------------------------------------------------------------
# Runtime Configuration
# -----------------------------------------------------------------------------

# Disable OpenTelemetry exports to avoid 429 errors from LiveKit Cloud
ENV OTEL_TRACES_EXPORTER=none \
    OTEL_LOGS_EXPORTER=none \
    OTEL_METRICS_EXPORTER=none

# Create directories for runtime data (will be mounted or ephemeral)
RUN mkdir -p /app/recordings_buffer /app/.model_cache /app/analysis/logs

# Create non-root user for security
# Note: Comment out if host networking requires root
RUN useradd --create-home --shell /bin/bash appuser && \
    chown -R appuser:appuser /app
USER appuser

# Health check via LiveKit agent's built-in health endpoint
HEALTHCHECK --interval=30s --timeout=10s --start-period=15s --retries=3 \
    CMD curl -f http://localhost:8081/ || exit 1

# LiveKit agent connects outbound to LiveKit server (no inbound ports needed)
# Health endpoint on 8081 (optional)
EXPOSE 8081

# Default command: Start LiveKit agent worker using uv run
# 'start' = production mode (single process)
# 'dev' = development mode (hot reload)
CMD ["uv", "run", "-m", "agent.worker", "start"]

# =============================================================================
# VONAGE VOICE AGENT - DOCKER COMPOSE
# =============================================================================
# Orchestrates API and Worker containers for development and testing
#
# Usage:
#   Development:  docker compose up --build
#   Production:   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#   Scale workers: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --scale worker=3
#
# IMPORTANT: For production, the Worker should use --network host
# This file uses bridge networking for development convenience
#
# Configure WORKER_REPLICAS in .env to control how many workers to run
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # API Service - FastAPI REST endpoints
  # ---------------------------------------------------------------------------
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: vonage-voice-agent-api
    ports:
      - "${API_PORT:-8000}:8000"
    env_file:
      - .env
    environment:
      - PORT=8000
      # Override secrets paths for container (mounted at /app/secrets)
      - GCS_CREDENTIALS_JSON=/app/secrets/salesmaya-yts-6b49f7694826.json
      - GOOGLE_OAUTH_CLIENT_SECRETS=/app/secrets/google_oauth_client_secret.json
    volumes:
      # Mount secrets folder for GCS credentials (read-only)
      - ./secrets:/app/secrets:ro
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/healthz" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Worker Service - LiveKit Agent (scalable)
  # ---------------------------------------------------------------------------
  # NOTE: In production, use --network host for best WebRTC performance
  # Scale with: --scale worker=N  or set WORKER_REPLICAS in .env
  # No container_name set - allows scaling to multiple instances
  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    env_file:
      - .env
    environment:
      - MAX_CONCURRENT_CALLS=${MAX_CONCURRENT_CALLS:-1}
      # Override secrets paths for container (mounted at /app/secrets)
      - GCS_CREDENTIALS_JSON=/app/secrets/salesmaya-yts-6b49f7694826.json
      - GOOGLE_OAUTH_CLIENT_SECRETS=/app/secrets/google_oauth_client_secret.json
    volumes:
      # Mount secrets folder for credentials (read-only)
      - ./secrets:/app/secrets:ro
      # Model cache persistence across container restarts
      - model_cache:/app/.model_cache
    # Health check: verify main process is running (no extra packages needed)
    healthcheck:
      test: [ "CMD-SHELL", "grep -qa agent.worker /proc/1/cmdline" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    # Increase shared memory for audio processing
    shm_size: '256m'

# Persistent volumes
volumes:
  model_cache:
    name: vonage-voice-agent-model-cache
